"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConfigParser = void 0;
const validator_1 = require("./validator");
class ConfigParser {
    static parse(scope, stage, defaults) {
        const validator = new validator_1.ConfigValidator();
        const domainName = this.getContextForType(scope, 'domainName', 'string', defaults);
        const engineVersion = this.getContextForType(scope, 'engineVersion', 'string', defaults);
        const dataNodeType = this.getContextForType(scope, 'dataNodeType', 'string', defaults);
        const dataNodeCount = this.getContextForType(scope, 'dataNodeCount', 'number', defaults);
        const dedicatedManagerNodeType = this.getContextForType(scope, 'dedicatedManagerNodeType', 'string', defaults);
        const dedicatedManagerNodeCount = this.getContextForType(scope, 'dedicatedManagerNodeCount', 'number', defaults);
        const warmNodeType = this.getContextForType(scope, 'warmNodeType', 'string', defaults);
        const warmNodeCount = this.getContextForType(scope, 'warmNodeCount', 'number', defaults);
        const ebsEnabled = this.getContextForType(scope, 'ebsEnabled', 'boolean', defaults);
        const ebsIops = this.getContextForType(scope, 'ebsIops', 'number', defaults);
        const ebsVolumeSize = this.getContextForType(scope, 'ebsVolumeSize', 'number', defaults);
        const ebsVolumeType = this.getContextForType(scope, 'ebsVolumeType', 'string', defaults);
        const vpcEnabled = this.getContextForType(scope, 'vpcEnabled', 'boolean', defaults);
        const vpcId = this.getContextForType(scope, 'vpcId', 'string', defaults);
        const vpcSubnetIds = this.getContextForType(scope, 'vpcSubnetIds', 'object', defaults);
        const vpcSecurityGroupIds = this.getContextForType(scope, 'vpcSecurityGroupIds', 'object', defaults);
        const availabilityZoneCount = this.getContextForType(scope, 'availabilityZoneCount', 'number', defaults);
        const eksLogGroupName = this.getContextForType(scope, 'eksLogGroupName', 'string', defaults);
        const podLogGroupName = this.getContextForType(scope, 'podLogGroupName', 'string', defaults);
        const services = this.getContextForType(scope, 'services', 'object', defaults);
        validator.validateRequired(domainName, 'domainName');
        validator.validateEngineVersion(engineVersion);
        validator.validateEbsVolumeType(ebsVolumeType);
        return {
            openSearch: {
                domainName: domainName,
                engineVersion: engineVersion,
                dataNodeType: dataNodeType || 't3.small.search',
                dataNodeCount: dataNodeCount || 1,
                dedicatedManagerNodeType,
                dedicatedManagerNodeCount,
                warmNodeType,
                warmNodeCount,
                ebsEnabled: ebsEnabled !== undefined ? ebsEnabled : true,
                ebsIops,
                ebsVolumeSize: ebsVolumeSize || 10,
                ebsVolumeType,
                availabilityZoneCount: availabilityZoneCount || 1,
            },
            network: {
                vpcEnabled: vpcEnabled || false,
                vpcId,
                vpcSubnetIds,
                vpcSecurityGroupIds,
                availabilityZoneCount: availabilityZoneCount || 1,
            },
            logs: {
                services: this.parseServices(services, defaults.services),
                // Backward compatibility
                eksLogGroupName,
                podLogGroupName,
            },
            stage,
        };
    }
    static getContextForType(scope, optionName, expectedType, defaultValues) {
        const option = scope.node.tryGetContext(optionName);
        // If no context is provided (undefined or empty string) and a default value exists, use it
        if ((option === undefined || option === "") && defaultValues[optionName]) {
            return defaultValues[optionName];
        }
        // Filter out invalid or missing options by setting undefined (empty strings, null, undefined, NaN)
        if (option !== false && option !== 0 && !option) {
            return undefined;
        }
        // Values provided by the CLI will always be represented as a string and need to be parsed
        if (typeof option === 'string') {
            if (expectedType === 'number') {
                const parsed = parseInt(option);
                if (isNaN(parsed)) {
                    throw new Error(`Invalid number format for ${optionName}: ${option}`);
                }
                return parsed;
            }
            if (expectedType === 'boolean' || expectedType === 'object') {
                try {
                    return JSON.parse(option);
                }
                catch (error) {
                    throw new Error(`Invalid JSON format for ${optionName}: ${option}`);
                }
            }
        }
        // Values provided by the cdk.context.json should be of the desired type
        if (typeof option !== expectedType) {
            throw new Error(`Type provided by cdk.context.json for ${optionName} was ${typeof option} but expected ${expectedType}`);
        }
        return option;
    }
    static parseServices(contextServices, defaultServices) {
        const services = {};
        // Parse services from context
        if (contextServices && typeof contextServices === 'object') {
            Object.entries(contextServices).forEach(([serviceName, serviceConfig]) => {
                if (typeof serviceConfig === 'object' && serviceConfig !== null) {
                    const config = serviceConfig;
                    services[serviceName] = {
                        logGroupName: config.logGroupName || '',
                        indexName: config.indexName || `${serviceName}-logs`,
                        processorType: config.processorType || serviceName,
                        enabled: config.enabled !== false
                    };
                }
            });
        }
        // Merge with default services
        if (defaultServices) {
            Object.entries(defaultServices).forEach(([serviceName, defaultConfig]) => {
                if (!services[serviceName] && defaultConfig.logGroupName) {
                    services[serviceName] = {
                        logGroupName: defaultConfig.logGroupName,
                        indexName: defaultConfig.indexName || `${serviceName}-logs`,
                        processorType: defaultConfig.processorType || serviceName,
                        enabled: defaultConfig.enabled !== false
                    };
                }
            });
        }
        return services;
    }
}
exports.ConfigParser = ConfigParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDJDQUE4QztBQUU5QyxNQUFhLFlBQVk7SUFFckIsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFnQixFQUFFLEtBQWEsRUFBRSxRQUEyQjtRQUNyRSxNQUFNLFNBQVMsR0FBRyxJQUFJLDJCQUFlLEVBQUUsQ0FBQztRQUV4QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbkYsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3pGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2RixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDekYsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLDBCQUEwQixFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMvRyxNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsMkJBQTJCLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pILE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2RixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLGVB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ZSxFQUFFLENBQUM7WUFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsRUFBRSxFQUFFO2dCQUNyRSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFDdkQsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHO3dCQUNwQixZQUFZLEVBQUUsYUFBYSxDQUFDLFlBQVk7d0JBQ3hDLFNBQVMsRUFBRSxhQUFhLENBQUMsU0FBUyxJQUFJLEdBQUcsV0FBVyxPQUFPO3dCQUMzRCxhQUFhLEVBQUUsYUFBYSxDQUFDLGFBQWEsSUFBSSxXQUFXO3dCQUN6RCxPQUFPLEVBQUUsYUFBYSxDQUFDLE9BQU8sS0FBSyxLQUFLO3FCQUMzQyxDQUFDO2dCQUNOLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUE3SUQsb0NBNklDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IFJhd0NvbmZpZ0RlZmF1bHRzLCBTdGFja0NvbmZpZ3VyYXRpb24sIFNlcnZpY2VMb2dDb25maWcsIFJhd1NlcnZpY2VMb2dDb25maWcgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IHsgQ29uZmlnVmFsaWRhdG9yIH0gZnJvbSBcIi4vdmFsaWRhdG9yXCI7XG5cbmV4cG9ydCBjbGFzcyBDb25maWdQYXJzZXIge1xuICAgIFxuICAgIHN0YXRpYyBwYXJzZShzY29wZTogQ29uc3RydWN0LCBzdGFnZTogc3RyaW5nLCBkZWZhdWx0czogUmF3Q29uZmlnRGVmYXVsdHMpOiBTdGFja0NvbmZpZ3VyYXRpb24ge1xuICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgQ29uZmlnVmFsaWRhdG9yKCk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBkb21haW5OYW1lID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ2RvbWFpbk5hbWUnLCAnc3RyaW5nJywgZGVmYXVsdHMpO1xuICAgICAgICBjb25zdCBlbmdpbmVWZXJzaW9uID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ2VuZ2luZVZlcnNpb24nLCAnc3RyaW5nJywgZGVmYXVsdHMpO1xuICAgICAgICBjb25zdCBkYXRhTm9kZVR5cGUgPSB0aGlzLmdldENvbnRleHRGb3JUeXBlKHNjb3BlLCAnZGF0YU5vZGVUeXBlJywgJ3N0cmluZycsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgZGF0YU5vZGVDb3VudCA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICdkYXRhTm9kZUNvdW50JywgJ251bWJlcicsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgZGVkaWNhdGVkTWFuYWdlck5vZGVUeXBlID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ2RlZGljYXRlZE1hbmFnZXJOb2RlVHlwZScsICdzdHJpbmcnLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IGRlZGljYXRlZE1hbmFnZXJOb2RlQ291bnQgPSB0aGlzLmdldENvbnRleHRGb3JUeXBlKHNjb3BlLCAnZGVkaWNhdGVkTWFuYWdlck5vZGVDb3VudCcsICdudW1iZXInLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IHdhcm1Ob2RlVHlwZSA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICd3YXJtTm9kZVR5cGUnLCAnc3RyaW5nJywgZGVmYXVsdHMpO1xuICAgICAgICBjb25zdCB3YXJtTm9kZUNvdW50ID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ3dhcm1Ob2RlQ291bnQnLCAnbnVtYmVyJywgZGVmYXVsdHMpO1xuICAgICAgICBjb25zdCBlYnNFbmFibGVkID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ2Vic0VuYWJsZWQnLCAnYm9vbGVhbicsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgZWJzSW9wcyA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICdlYnNJb3BzJywgJ251bWJlcicsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgZWJzVm9sdW1lU2l6ZSA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICdlYnNWb2x1bWVTaXplJywgJ251bWJlcicsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgZWJzVm9sdW1lVHlwZSA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICdlYnNWb2x1bWVUeXBlJywgJ3N0cmluZycsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgdnBjRW5hYmxlZCA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICd2cGNFbmFibGVkJywgJ2Jvb2xlYW4nLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IHZwY0lkID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ3ZwY0lkJywgJ3N0cmluZycsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgdnBjU3VibmV0SWRzID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ3ZwY1N1Ym5ldElkcycsICdvYmplY3QnLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IHZwY1NlY3VyaXR5R3JvdXBJZHMgPSB0aGlzLmdldENvbnRleHRGb3JUeXBlKHNjb3BlLCAndnBjU2VjdXJpdHlHcm91cElkcycsICdvYmplY3QnLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IGF2YWlsYWJpbGl0eVpvbmVDb3VudCA9IHRoaXMuZ2V0Q29udGV4dEZvclR5cGUoc2NvcGUsICdhdmFpbGFiaWxpdHlab25lQ291bnQnLCAnbnVtYmVyJywgZGVmYXVsdHMpO1xuICAgICAgICBjb25zdCBla3NMb2dHcm91cE5hbWUgPSB0aGlzLmdldENvbnRleHRGb3JUeXBlKHNjb3BlLCAnZWtzTG9nR3JvdXBOYW1lJywgJ3N0cmluZycsIGRlZmF1bHRzKTtcbiAgICAgICAgY29uc3QgcG9kTG9nR3JvdXBOYW1lID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ3BvZExvZ0dyb3VwTmFtZScsICdzdHJpbmcnLCBkZWZhdWx0cyk7XG4gICAgICAgIGNvbnN0IHNlcnZpY2VzID0gdGhpcy5nZXRDb250ZXh0Rm9yVHlwZShzY29wZSwgJ3NlcnZpY2VzJywgJ29iamVjdCcsIGRlZmF1bHRzKTtcblxuICAgICAgICB2YWxpZGF0b3IudmFsaWRhdGVSZXF1aXJlZChkb21haW5OYW1lLCAnZG9tYWluTmFtZScpO1xuICAgICAgICB2YWxpZGF0b3IudmFsaWRhdGVFbmdpbmVWZXJzaW9uKGVuZ2luZVZlcnNpb24pO1xuICAgICAgICB2YWxpZGF0b3IudmFsaWRhdGVFYnNWb2x1bWVUeXBlKGVic1ZvbHVtZVR5cGUpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvcGVuU2VhcmNoOiB7XG4gICAgICAgICAgICAgICAgZG9tYWluTmFtZTogZG9tYWluTmFtZSEsXG4gICAgICAgICAgICAgICAgZW5naW5lVmVyc2lvbjogZW5naW5lVmVyc2lvbiEsXG4gICAgICAgICAgICAgICAgZGF0YU5vZGVUeXBlOiBkYXRhTm9kZVR5cGUgfHwgJ3QzLnNtYWxsLnNlYXJjaCcsXG4gICAgICAgICAgICAgICAgZGF0YU5vZGVDb3VudDogZGF0YU5vZGVDb3VudCB8fCAxLFxuICAgICAgICAgICAgICAgIGRlZGljYXRlZE1hbmFnZXJOb2RlVHlwZSxcbiAgICAgICAgICAgICAgICBkZWRpY2F0ZWRNYW5hZ2VyTm9kZUNvdW50LFxuICAgICAgICAgICAgICAgIHdhcm1Ob2RlVHlwZSxcbiAgICAgICAgICAgICAgICB3YXJtTm9kZUNvdW50LFxuICAgICAgICAgICAgICAgIGVic0VuYWJsZWQ6IGVic0VuYWJsZWQgIT09IHVuZGVmaW5lZCA/IGVic0VuYWJsZWQgOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVic0lvcHMsXG4gICAgICAgICAgICAgICAgZWJzVm9sdW1lU2l6ZTogZWJzVm9sdW1lU2l6ZSB8fCAxMCxcbiAgICAgICAgICAgICAgICBlYnNWb2x1bWVUeXBlLFxuICAgICAgICAgICAgICAgIGF2YWlsYWJpbGl0eVpvbmVDb3VudDogYXZhaWxhYmlsaXR5Wm9uZUNvdW50IHx8IDEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbmV0d29yazoge1xuICAgICAgICAgICAgICAgIHZwY0VuYWJsZWQ6IHZwY0VuYWJsZWQgfHwgZmFsc2UsXG4gICAgICAgICAgICAgICAgdnBjSWQsXG4gICAgICAgICAgICAgICAgdnBjU3VibmV0SWRzLFxuICAgICAgICAgICAgICAgIHZwY1NlY3VyaXR5R3JvdXBJZHMsXG4gICAgICAgICAgICAgICAgYXZhaWxhYmlsaXR5Wm9uZUNvdW50OiBhdmFpbGFiaWxpdHlab25lQ291bnQgfHwgMSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBsb2dzOiB7XG4gICAgICAgICAgICAgICAgc2VydmljZXM6IHRoaXMucGFyc2VTZXJ2aWNlcyhzZXJ2aWNlcywgZGVmYXVsdHMuc2VydmljZXMpLFxuICAgICAgICAgICAgICAgIC8vIEJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgICAgICBla3NMb2dHcm91cE5hbWUsXG4gICAgICAgICAgICAgICAgcG9kTG9nR3JvdXBOYW1lLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN0YWdlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldENvbnRleHRGb3JUeXBlKFxuICAgICAgICBzY29wZTogQ29uc3RydWN0LCBcbiAgICAgICAgb3B0aW9uTmFtZTogc3RyaW5nLCBcbiAgICAgICAgZXhwZWN0ZWRUeXBlOiBzdHJpbmcsIFxuICAgICAgICBkZWZhdWx0VmFsdWVzOiBSYXdDb25maWdEZWZhdWx0c1xuICAgICk6IGFueSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IHNjb3BlLm5vZGUudHJ5R2V0Q29udGV4dChvcHRpb25OYW1lKTtcblxuICAgICAgICAvLyBJZiBubyBjb250ZXh0IGlzIHByb3ZpZGVkICh1bmRlZmluZWQgb3IgZW1wdHkgc3RyaW5nKSBhbmQgYSBkZWZhdWx0IHZhbHVlIGV4aXN0cywgdXNlIGl0XG4gICAgICAgIGlmICgob3B0aW9uID09PSB1bmRlZmluZWQgfHwgb3B0aW9uID09PSBcIlwiKSAmJiBkZWZhdWx0VmFsdWVzW29wdGlvbk5hbWUgYXMga2V5b2YgUmF3Q29uZmlnRGVmYXVsdHNdKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlc1tvcHRpb25OYW1lIGFzIGtleW9mIFJhd0NvbmZpZ0RlZmF1bHRzXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZpbHRlciBvdXQgaW52YWxpZCBvciBtaXNzaW5nIG9wdGlvbnMgYnkgc2V0dGluZyB1bmRlZmluZWQgKGVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCwgTmFOKVxuICAgICAgICBpZiAob3B0aW9uICE9PSBmYWxzZSAmJiBvcHRpb24gIT09IDAgJiYgIW9wdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbHVlcyBwcm92aWRlZCBieSB0aGUgQ0xJIHdpbGwgYWx3YXlzIGJlIHJlcHJlc2VudGVkIGFzIGEgc3RyaW5nIGFuZCBuZWVkIHRvIGJlIHBhcnNlZFxuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGlmIChleHBlY3RlZFR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2VJbnQob3B0aW9uKTtcbiAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocGFyc2VkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgbnVtYmVyIGZvcm1hdCBmb3IgJHtvcHRpb25OYW1lfTogJHtvcHRpb259YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXhwZWN0ZWRUeXBlID09PSAnYm9vbGVhbicgfHwgZXhwZWN0ZWRUeXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKG9wdGlvbik7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIEpTT04gZm9ybWF0IGZvciAke29wdGlvbk5hbWV9OiAke29wdGlvbn1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWx1ZXMgcHJvdmlkZWQgYnkgdGhlIGNkay5jb250ZXh0Lmpzb24gc2hvdWxkIGJlIG9mIHRoZSBkZXNpcmVkIHR5cGVcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb24gIT09IGV4cGVjdGVkVHlwZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUeXBlIHByb3ZpZGVkIGJ5IGNkay5jb250ZXh0Lmpzb24gZm9yICR7b3B0aW9uTmFtZX0gd2FzICR7dHlwZW9mIG9wdGlvbn0gYnV0IGV4cGVjdGVkICR7ZXhwZWN0ZWRUeXBlfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9wdGlvbjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBwYXJzZVNlcnZpY2VzKGNvbnRleHRTZXJ2aWNlczogYW55LCBkZWZhdWx0U2VydmljZXM/OiB7IFtrZXk6IHN0cmluZ106IFJhd1NlcnZpY2VMb2dDb25maWcgfSk6IHsgW2tleTogc3RyaW5nXTogU2VydmljZUxvZ0NvbmZpZyB9IHtcbiAgICAgICAgY29uc3Qgc2VydmljZXM6IHsgW2tleTogc3RyaW5nXTogU2VydmljZUxvZ0NvbmZpZyB9ID0ge307XG4gICAgICAgIFxuICAgICAgICAvLyBQYXJzZSBzZXJ2aWNlcyBmcm9tIGNvbnRleHRcbiAgICAgICAgaWYgKGNvbnRleHRTZXJ2aWNlcyAmJiB0eXBlb2YgY29udGV4dFNlcnZpY2VzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoY29udGV4dFNlcnZpY2VzKS5mb3JFYWNoKChbc2VydmljZU5hbWUsIHNlcnZpY2VDb25maWddKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlQ29uZmlnID09PSAnb2JqZWN0JyAmJiBzZXJ2aWNlQ29uZmlnICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2VDb25maWcgYXMgYW55O1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlc1tzZXJ2aWNlTmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dHcm91cE5hbWU6IGNvbmZpZy5sb2dHcm91cE5hbWUgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleE5hbWU6IGNvbmZpZy5pbmRleE5hbWUgfHwgYCR7c2VydmljZU5hbWV9LWxvZ3NgLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc29yVHlwZTogY29uZmlnLnByb2Nlc3NvclR5cGUgfHwgc2VydmljZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiBjb25maWcuZW5hYmxlZCAhPT0gZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE1lcmdlIHdpdGggZGVmYXVsdCBzZXJ2aWNlc1xuICAgICAgICBpZiAoZGVmYXVsdFNlcnZpY2VzKSB7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhkZWZhdWx0U2VydmljZXMpLmZvckVhY2goKFtzZXJ2aWNlTmFtZSwgZGVmYXVsdENvbmZpZ10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXNlcnZpY2VzW3NlcnZpY2VOYW1lXSAmJiBkZWZhdWx0Q29uZmlnLmxvZ0dyb3VwTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlc1tzZXJ2aWNlTmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dHcm91cE5hbWU6IGRlZmF1bHRDb25maWcubG9nR3JvdXBOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhOYW1lOiBkZWZhdWx0Q29uZmlnLmluZGV4TmFtZSB8fCBgJHtzZXJ2aWNlTmFtZX0tbG9nc2AsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzb3JUeXBlOiBkZWZhdWx0Q29uZmlnLnByb2Nlc3NvclR5cGUgfHwgc2VydmljZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiBkZWZhdWx0Q29uZmlnLmVuYWJsZWQgIT09IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2VydmljZXM7XG4gICAgfVxufSJdfQ==