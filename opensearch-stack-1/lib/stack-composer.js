"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackComposer = void 0;
const opensearch_domain_stack_1 = require("./opensearch-domain-stack");
const network_stack_1 = require("./network-stack");
const kinesis_firehose_app_stack_1 = require("./kinesis-firehose-app-stack");
const config_1 = require("./config");
const validator_1 = require("./config/validator");
class StackComposer {
    stacks = [];
    constructor(scope, props) {
        const config = config_1.ConfigManager.loadConfiguration(scope, props.stage);
        const validator = new validator_1.ConfigValidator();
        const parsedConfig = validator.validateAndTransformConfig(config);
        let networkStack;
        // If enabled re-use existing VPC and/or associated resources or create new
        if (config.network.vpcEnabled) {
            networkStack = new network_stack_1.NetworkStack(scope, 'networkStack', {
                vpcId: config.network.vpcId,
                vpcSubnetIds: config.network.vpcSubnetIds,
                vpcSecurityGroupIds: config.network.vpcSecurityGroupIds,
                availabilityZoneCount: config.network.availabilityZoneCount,
                stackName: `OSServiceNetworkCDKStack-${config.openSearch.domainName}`,
                description: "This stack contains resources to create/manage networking for an OpenSearch Service domain",
                ...props,
            });
            this.stacks.push(networkStack);
        }
        const opensearchStack = new opensearch_domain_stack_1.OpenSearchDomainStack(scope, 'opensearchServiceDomainCdkStack', {
            version: parsedConfig.version,
            domainName: parsedConfig.domainName,
            dataNodeInstanceType: parsedConfig.dataNodeType,
            dataNodes: parsedConfig.dataNodeCount,
            dedicatedManagerNodeType: parsedConfig.dedicatedManagerNodeType,
            dedicatedManagerNodeCount: parsedConfig.dedicatedManagerNodeCount,
            warmInstanceType: parsedConfig.warmNodeType,
            warmNodes: parsedConfig.warmNodeCount,
            ebsEnabled: parsedConfig.ebsEnabled,
            ebsIops: parsedConfig.ebsIops,
            ebsVolumeSize: parsedConfig.ebsVolumeSize,
            ebsVolumeType: parsedConfig.ebsVolumeType,
            vpc: networkStack ? networkStack.vpc : undefined,
            vpcSubnets: networkStack ? networkStack.domainSubnets : undefined,
            vpcSecurityGroups: networkStack ? networkStack.domainSecurityGroups : undefined,
            availabilityZoneCount: parsedConfig.availabilityZoneCount,
            stackName: `OSServiceDomainCDKStack-${parsedConfig.domainName}`,
            description: "This stack contains an OpenSearch Service domain",
            ...props,
        });
        this.stacks.push(opensearchStack);
        // Create Firehose stacks for each app type configuration
        config.logs.appTypeConfigs.forEach((appTypeConfig, index) => {
            // Clean app type name for CDK naming (replace underscores with dashes, capitalize words)
            const cleanAppType = appTypeConfig.appType.replace(/_/g, '-');
            const capitalizedAppType = cleanAppType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
            const appFirehoseStack = new kinesis_firehose_app_stack_1.KinesisFirehoseAppStack(scope, `kinesisFirehose${capitalizedAppType}Stack`, {
                opensearchDomain: opensearchStack.domain,
                opensearchStackName: opensearchStack.stackName,
                appTypeConfig: appTypeConfig,
                stackName: `KinesisFirehose${capitalizedAppType}CDKStack-${parsedConfig.domainName}`,
                description: `This stack contains Kinesis Data Firehose delivery streams for ${appTypeConfig.appType} logs`,
                ...props,
            });
            this.stacks.push(appFirehoseStack);
        });
    }
}
exports.StackComposer = StackComposer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stY29tcG9zZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFjay1jb21wb3Nlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx1RUFBZ0U7QUFDaEUsbURBQTZDO0FBQzdDLDZFQUFxRTtBQUNyRSxxQ0FBbUY7QUFDbkYsa0RBQW1EO0FBTW5ELE1BQWEsYUFBYTtJQUNmLE1BQU0sR0FBWSxFQUFFLENBQUM7SUFFNUIsWUFBWSxLQUFnQixFQUFFLEtBQW9CO1FBQzlDLE1BQU0sTUFBTSxHQUFHLHNCQUFhLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuRSxNQUFNLFNBQVMsR0FBRyxJQUFJLDJCQUFlLEVBQUUsQ0FBQztRQUN4QyxNQUFNLFlBQVksR0FBRyxTQUFTLENBQUMsMEJBQTBCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbEUsSUFBSSxZQUFzQyxDQUFDO1FBRTNDLDJFQUEyRTtRQUMzRSxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDNUIsWUFBWSxHQUFHLElBQUksNEJBQVksQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFO2dCQUNuRCxLQUFLLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLO2dCQUMzQixZQUFZLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZO2dCQUN6QyxtQkFBbUIsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLG1CQUFtQjtnQkFDdkQscUJBQXFCLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUI7Z0JBQzNELFNBQVMsRUFBRSw0QkFBNEIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3JFLFdBQVcsRUFBRSw0RkFBNEY7Z0JBQ3pHLEdBQUcsS0FBSzthQUNYLENBQUMsQ0FBQTtZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQ2xDLENBQUM7UUFFRCxNQUFNLGVBQWUsR0FBRyxJQUFJLCtDQUFxQixDQUFDLEtBQUssRUFBRSxpQ0FBaUMsRUFBRTtZQUN4RixPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU87WUFDN0IsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVO1lBQ25DLG9CQUFvQixFQUFFLFlBQVksQ0FBQyxZQUFZO1lBQy9DLFNBQVMsRUFBRSxZQUFZLENBQUMsYUFBYTtZQUNyQyx3QkFBd0IsRUFBRSxZQUFZLENBQUMsd0JBQXdCO1lBQy9ELHlCQUF5QixFQUFFLFlBQVksQ0FBQyx5QkFBeUI7WUFDakUsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLFlBQVk7WUFDM0MsU0FBUyxFQUFFLFlBQVksQ0FBQyxhQUFhO1lBQ3JDLFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTtZQUNuQyxPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU87WUFDN0IsYUFBYSxFQUFFLFlBQVksQ0FBQyxhQUFhO1lBQ3pDLGFBQWEsRUFBRSxZQUFZLENBQUMsYUFBYTtZQUN6QyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ2hELFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDakUsaUJBQWlCLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDL0UscUJBQXFCLEVBQUUsWUFBWSxDQUFDLHFCQUFxQjtZQUN6RCxTQUFTLEVBQUUsMkJBQTJCLFlBQVksQ0FBQyxVQUFVLEVBQUU7WUFDL0QsV0FBVyxFQUFFLGtEQUFrRDtZQUMvRCxHQUFHLEtBQUs7U0FDWCxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUVqQyx5REFBeUQ7UUFDekQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsYUFBYSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3hELHlGQUF5RjtZQUN6RixNQUFNLFlBQVksR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDOUQsTUFBTSxrQkFBa0IsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUMxRCxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQy9DLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRVgsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLG9EQUF1QixDQUFDLEtBQUssRUFBRSxrQkFBa0Isa0JBQWtCLE9BQU8sRUFBRTtnQkFDckcsZ0JBQWdCLEVBQUUsZUFBZSxDQUFDLE1BQU07Z0JBQ3hDLG1CQUFtQixFQUFFLGVBQWUsQ0FBQyxTQUFTO2dCQUM5QyxhQUFhLEVBQUUsYUFBYTtnQkFDNUIsU0FBUyxFQUFFLGtCQUFrQixrQkFBa0IsWUFBWSxZQUFZLENBQUMsVUFBVSxFQUFFO2dCQUNwRixXQUFXLEVBQUUsa0VBQWtFLGFBQWEsQ0FBQyxPQUFPLE9BQU87Z0JBQzNHLEdBQUcsS0FBSzthQUNYLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFsRUQsc0NBa0VDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb25zdHJ1Y3R9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQge1N0YWNrLCBTdGFja1Byb3BzfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7T3BlblNlYXJjaERvbWFpblN0YWNrfSBmcm9tIFwiLi9vcGVuc2VhcmNoLWRvbWFpbi1zdGFja1wiO1xuaW1wb3J0IHtOZXR3b3JrU3RhY2t9IGZyb20gXCIuL25ldHdvcmstc3RhY2tcIjtcbmltcG9ydCB7S2luZXNpc0ZpcmVob3NlQXBwU3RhY2t9IGZyb20gXCIuL2tpbmVzaXMtZmlyZWhvc2UtYXBwLXN0YWNrXCI7XG5pbXBvcnQge0NvbmZpZ01hbmFnZXIsIFN0YWNrQ29uZmlndXJhdGlvbiwgUGFyc2VkT3BlblNlYXJjaENvbmZpZ30gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQge0NvbmZpZ1ZhbGlkYXRvcn0gZnJvbSBcIi4vY29uZmlnL3ZhbGlkYXRvclwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFN0YWNrUHJvcHNFeHQgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgICByZWFkb25seSBzdGFnZTogc3RyaW5nXG59XG5cbmV4cG9ydCBjbGFzcyBTdGFja0NvbXBvc2VyIHtcbiAgICBwdWJsaWMgc3RhY2tzOiBTdGFja1tdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBwcm9wczogU3RhY2tQcm9wc0V4dCkge1xuICAgICAgICBjb25zdCBjb25maWcgPSBDb25maWdNYW5hZ2VyLmxvYWRDb25maWd1cmF0aW9uKHNjb3BlLCBwcm9wcy5zdGFnZSk7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBDb25maWdWYWxpZGF0b3IoKTtcbiAgICAgICAgY29uc3QgcGFyc2VkQ29uZmlnID0gdmFsaWRhdG9yLnZhbGlkYXRlQW5kVHJhbnNmb3JtQ29uZmlnKGNvbmZpZyk7XG4gICAgICAgIFxuICAgICAgICBsZXQgbmV0d29ya1N0YWNrOiBOZXR3b3JrU3RhY2sgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgLy8gSWYgZW5hYmxlZCByZS11c2UgZXhpc3RpbmcgVlBDIGFuZC9vciBhc3NvY2lhdGVkIHJlc291cmNlcyBvciBjcmVhdGUgbmV3XG4gICAgICAgIGlmIChjb25maWcubmV0d29yay52cGNFbmFibGVkKSB7XG4gICAgICAgICAgICBuZXR3b3JrU3RhY2sgPSBuZXcgTmV0d29ya1N0YWNrKHNjb3BlLCAnbmV0d29ya1N0YWNrJywge1xuICAgICAgICAgICAgICAgIHZwY0lkOiBjb25maWcubmV0d29yay52cGNJZCxcbiAgICAgICAgICAgICAgICB2cGNTdWJuZXRJZHM6IGNvbmZpZy5uZXR3b3JrLnZwY1N1Ym5ldElkcyxcbiAgICAgICAgICAgICAgICB2cGNTZWN1cml0eUdyb3VwSWRzOiBjb25maWcubmV0d29yay52cGNTZWN1cml0eUdyb3VwSWRzLFxuICAgICAgICAgICAgICAgIGF2YWlsYWJpbGl0eVpvbmVDb3VudDogY29uZmlnLm5ldHdvcmsuYXZhaWxhYmlsaXR5Wm9uZUNvdW50LFxuICAgICAgICAgICAgICAgIHN0YWNrTmFtZTogYE9TU2VydmljZU5ldHdvcmtDREtTdGFjay0ke2NvbmZpZy5vcGVuU2VhcmNoLmRvbWFpbk5hbWV9YCxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJUaGlzIHN0YWNrIGNvbnRhaW5zIHJlc291cmNlcyB0byBjcmVhdGUvbWFuYWdlIG5ldHdvcmtpbmcgZm9yIGFuIE9wZW5TZWFyY2ggU2VydmljZSBkb21haW5cIixcbiAgICAgICAgICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB0aGlzLnN0YWNrcy5wdXNoKG5ldHdvcmtTdGFjaylcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG9wZW5zZWFyY2hTdGFjayA9IG5ldyBPcGVuU2VhcmNoRG9tYWluU3RhY2soc2NvcGUsICdvcGVuc2VhcmNoU2VydmljZURvbWFpbkNka1N0YWNrJywge1xuICAgICAgICAgICAgdmVyc2lvbjogcGFyc2VkQ29uZmlnLnZlcnNpb24sXG4gICAgICAgICAgICBkb21haW5OYW1lOiBwYXJzZWRDb25maWcuZG9tYWluTmFtZSxcbiAgICAgICAgICAgIGRhdGFOb2RlSW5zdGFuY2VUeXBlOiBwYXJzZWRDb25maWcuZGF0YU5vZGVUeXBlLFxuICAgICAgICAgICAgZGF0YU5vZGVzOiBwYXJzZWRDb25maWcuZGF0YU5vZGVDb3VudCxcbiAgICAgICAgICAgIGRlZGljYXRlZE1hbmFnZXJOb2RlVHlwZTogcGFyc2VkQ29uZmlnLmRlZGljYXRlZE1hbmFnZXJOb2RlVHlwZSxcbiAgICAgICAgICAgIGRlZGljYXRlZE1hbmFnZXJOb2RlQ291bnQ6IHBhcnNlZENvbmZpZy5kZWRpY2F0ZWRNYW5hZ2VyTm9kZUNvdW50LFxuICAgICAgICAgICAgd2FybUluc3RhbmNlVHlwZTogcGFyc2VkQ29uZmlnLndhcm1Ob2RlVHlwZSxcbiAgICAgICAgICAgIHdhcm1Ob2RlczogcGFyc2VkQ29uZmlnLndhcm1Ob2RlQ291bnQsXG4gICAgICAgICAgICBlYnNFbmFibGVkOiBwYXJzZWRDb25maWcuZWJzRW5hYmxlZCxcbiAgICAgICAgICAgIGVic0lvcHM6IHBhcnNlZENvbmZpZy5lYnNJb3BzLFxuICAgICAgICAgICAgZWJzVm9sdW1lU2l6ZTogcGFyc2VkQ29uZmlnLmVic1ZvbHVtZVNpemUsXG4gICAgICAgICAgICBlYnNWb2x1bWVUeXBlOiBwYXJzZWRDb25maWcuZWJzVm9sdW1lVHlwZSxcbiAgICAgICAgICAgIHZwYzogbmV0d29ya1N0YWNrID8gbmV0d29ya1N0YWNrLnZwYyA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHZwY1N1Ym5ldHM6IG5ldHdvcmtTdGFjayA/IG5ldHdvcmtTdGFjay5kb21haW5TdWJuZXRzIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgdnBjU2VjdXJpdHlHcm91cHM6IG5ldHdvcmtTdGFjayA/IG5ldHdvcmtTdGFjay5kb21haW5TZWN1cml0eUdyb3VwcyA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGF2YWlsYWJpbGl0eVpvbmVDb3VudDogcGFyc2VkQ29uZmlnLmF2YWlsYWJpbGl0eVpvbmVDb3VudCxcbiAgICAgICAgICAgIHN0YWNrTmFtZTogYE9TU2VydmljZURvbWFpbkNES1N0YWNrLSR7cGFyc2VkQ29uZmlnLmRvbWFpbk5hbWV9YCxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIlRoaXMgc3RhY2sgY29udGFpbnMgYW4gT3BlblNlYXJjaCBTZXJ2aWNlIGRvbWFpblwiLFxuICAgICAgICAgICAgLi4ucHJvcHMsXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc3RhY2tzLnB1c2gob3BlbnNlYXJjaFN0YWNrKVxuXG4gICAgICAgIC8vIENyZWF0ZSBGaXJlaG9zZSBzdGFja3MgZm9yIGVhY2ggYXBwIHR5cGUgY29uZmlndXJhdGlvblxuICAgICAgICBjb25maWcubG9ncy5hcHBUeXBlQ29uZmlncy5mb3JFYWNoKChhcHBUeXBlQ29uZmlnLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgLy8gQ2xlYW4gYXBwIHR5cGUgbmFtZSBmb3IgQ0RLIG5hbWluZyAocmVwbGFjZSB1bmRlcnNjb3JlcyB3aXRoIGRhc2hlcywgY2FwaXRhbGl6ZSB3b3JkcylcbiAgICAgICAgICAgIGNvbnN0IGNsZWFuQXBwVHlwZSA9IGFwcFR5cGVDb25maWcuYXBwVHlwZS5yZXBsYWNlKC9fL2csICctJyk7XG4gICAgICAgICAgICBjb25zdCBjYXBpdGFsaXplZEFwcFR5cGUgPSBjbGVhbkFwcFR5cGUuc3BsaXQoJy0nKS5tYXAod29yZCA9PiBcbiAgICAgICAgICAgICAgICB3b3JkLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgd29yZC5zbGljZSgxKVxuICAgICAgICAgICAgKS5qb2luKCcnKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgYXBwRmlyZWhvc2VTdGFjayA9IG5ldyBLaW5lc2lzRmlyZWhvc2VBcHBTdGFjayhzY29wZSwgYGtpbmVzaXNGaXJlaG9zZSR7Y2FwaXRhbGl6ZWRBcHBUeXBlfVN0YWNrYCwge1xuICAgICAgICAgICAgICAgIG9wZW5zZWFyY2hEb21haW46IG9wZW5zZWFyY2hTdGFjay5kb21haW4sXG4gICAgICAgICAgICAgICAgb3BlbnNlYXJjaFN0YWNrTmFtZTogb3BlbnNlYXJjaFN0YWNrLnN0YWNrTmFtZSxcbiAgICAgICAgICAgICAgICBhcHBUeXBlQ29uZmlnOiBhcHBUeXBlQ29uZmlnLFxuICAgICAgICAgICAgICAgIHN0YWNrTmFtZTogYEtpbmVzaXNGaXJlaG9zZSR7Y2FwaXRhbGl6ZWRBcHBUeXBlfUNES1N0YWNrLSR7cGFyc2VkQ29uZmlnLmRvbWFpbk5hbWV9YCxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYFRoaXMgc3RhY2sgY29udGFpbnMgS2luZXNpcyBEYXRhIEZpcmVob3NlIGRlbGl2ZXJ5IHN0cmVhbXMgZm9yICR7YXBwVHlwZUNvbmZpZy5hcHBUeXBlfSBsb2dzYCxcbiAgICAgICAgICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5zdGFja3MucHVzaChhcHBGaXJlaG9zZVN0YWNrKTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==